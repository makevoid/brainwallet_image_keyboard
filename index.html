<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>
    <section>
      <h1>
        Brainwallet
        -
        <span class="buttons">
          <a data-fn="generate" href="#" onclick="javascript:void(0)">Generate</a>
          /
          <a data-fn="save" href="#" onclick="javascript:void(0)">Save</a>
          /
          <a data-fn="load" href="#" onclick="javascript:void(0)">Load</a>
          /
          <a data-fn="training" href="#" onclick="javascript:void(0)">Training</a>
        </span>
      </h1>
      <div id="keyWIF"></div>
      <div id="key"></div>
      <input id="input" type="text">
      <div id="brainwallet-words">
        <!--- elements will be inserted here -->
      </div>
    </section>
    <section id="open-source">
      The project is <a href='https://github.com/makevoid/imageswallet'>open source</a>.
    </section>


    <script type="text/javascript" src="/bower_components/underscore/underscore-min.js" ></script>
    <script type="text/javascript" src="/bower_components/underscore.string/dist/underscore.string.js" ></script>
    <!-- <script type="text/javascript" src="./node.js" ></script> -->
    <script type="text/javascript" src="/bower_components/bitcore-lib/bitcore-lib.min.js" ></script>
    <script type="text/javascript" src="/bower_components/bitcore-mnemonic/bitcore-mnemonic.min.js" ></script>


    <script  type="text/javascript" >
      "use strict";

      const d = document

      const bitcore  = require('bitcore-lib')
      const Mnemonic = require('bitcore-mnemonic')

      const ALL_WORDS = Mnemonic.Words.ENGLISH

      const get = (url) => {
        return new Promise((resolve, reject) => {
          // var xhrLoad = () => {
          //   resolve(this.responseText)
          // }
          var xhrLoad = function() {
            resolve(JSON.parse(this.responseText))
          }
          let oReq = new XMLHttpRequest()
          oReq.addEventListener("load", xhrLoad)
          oReq.open("GET", url)
          oReq.send()
        })
      }

      const loadWords = () => {
        // return get("/words/english.json")
        return new Promise((resolve, reject) =>
          resolve(ALL_WORDS)
        )
      }

      const wordTag = (imageUrl, word) => {
        return `<div class="word" data-word="${word}">
          <img class="img" src="${imageUrl}">
          <h3 class="text">${word}</h3>
        </div>`
      }

      const genImagesHtml = (words) => {
        let images = ""
        _(words).each((word) => {
          let imageUrl = `/images/english/${word}.jpg`
          images = `
          ${images}
          ${wordTag(imageUrl, word)}`
        })
        return images
      }

      const renderWords = (element, words) => {
        // words = _(words).first(500)
        let imagesHTML = genImagesHtml(words)
        element.innerHTML = imagesHTML
      }

      const generateWords = () => {
        let code = new Mnemonic(ALL_WORDS);
        let codeStr = code.toString()
        return codeStr
      }

      const showWords = (words) => {
        let key = d.querySelector("#key")
        renderWords(key, words)
      }

      // main
      (setTimeout(function(){
        const c = console
        const store = localStorage

        let KEY = generateWords()

        this.generate = (x) => {
          let words = generateWords()
          words = words.split(" ")
          showWords(words)
        }

        this.save = (x) => {
          store.privateKeyMnemonic = KEY
        }

        this.load = (x) => {
          KEY = store.privateKeyMnemonic
          let words = KEY.split(" ")
          showWords(words)
        }

        this.training = (x) => {
          c.log("TODO")
        }

        const linkClick = (evt) => {
          let fn = evt.target.dataset.fn.toString()
          c.log(`executing: ${fn}()`)
          this[fn]()
        }

        const links = d.querySelectorAll("a")
        _(links).map(function(link){
          link.addEventListener("click", linkClick, false)
        })

        const element = d.querySelector("#brainwallet-words")

        loadWords()
          .then((words) => {
            renderWords(element, words)
            let event = new Event('words-loaded')
            window.dispatchEvent(event)
          })
          .catch((err) => {
            c.error(err)
          })

        const onKey = (evt) => {
          let input = d.querySelector("#input")
          c.log(input.value)
        }

        const getPrivateKey = (words) => {
          let code = new Mnemonic(words.join(" "))
          return code.toHDPrivateKey()
        }

        const showPrivateKey = (words) => {
          let key = getPrivateKey(words)
          let elem = d.querySelector("#keyWIF")
          let keyString = key.privateKey.toWIF()
          let message = `PrivateKey:<br>${keyString}`
          elem.innerHTML = message
        }

        // TODO: training
        // d.querySelector("#input")
        // d.addEventListener("keyup", onKey)

        //

        const WORDS = []

        const wordAddDo = (word) => {
          if (WORDS.length < 12)
            WORDS.push(word)

          if (WORDS.length > 11)
            showPrivateKey(WORDS)

          showWords(WORDS)
        }

        const wordClick = (evt) => {
          let elem = evt.currentTarget
          let word = elem.dataset.word

          wordAddDo(word)
        }

        const wordsAddClickListener = () => {
          const wordElems = d.querySelectorAll("#brainwallet-words .word")
          _(wordElems).map(function(wordElem){
            wordElem.addEventListener("click", wordClick, false)
          })
        }

        window.addEventListener("words-loaded", wordsAddClickListener, false)

        const addWordToInput = (word, elem) => {
          if (_(ALL_WORDS).include(word)) {
            wordAddDo(word)
            elem.value = ""
          }
        }

        const wordsAddOnEnter = (evt) => {
          let enterPressed = evt.keyCode == 13
          if (enterPressed) {
            let elem = evt.target
            let word = elem.value
            addWordToInput(word, elem)
          }
        }

        let input = d.querySelector("#input")
        input.addEventListener("keydown", wordsAddOnEnter)

      }, 0))

    </script>

    <style>

      /* reset */
      html, body { font-size: 140%; padding:0; margin: 0; }
      a { text-decoration: none; }
      nav { display: inline-block; }
      section { margin: 0; padding: 20px 2%; }
      * { box-sizing: border-box }

      /* colors */
      html, body { height: 100% }
      a { color: #E00; }

      /* style: header */
      h1 { line-height: 90px; margin: 0; }
      h1 > span { font-size: 70%; }

      /* style: main: form */
      .word { display: inline-block }
      .word > .text { text-align: center }
      /*.word >*/
      /*.word > .img { width: 100% }*/
      .word > .img { background-size: contain; }
      /*.word { width: 19%; }*/
      /*.word > .img { height: 120px; width: 100%; }*/
      .word > .img { height: 150px; width: 150px; }
      .word > .text { line-height: 70px; margin: 0 0 20px 0; padding: 0 display:  block}

      /* style: main: colors */
      /* TODO: Webkit filters */

      /* style: interactivity */
      #brainwallet-words .word { cursor: pointer }
      .word > .text { color: #555 }
      .word:hover .text { color: #000 }
      .word:hover .img { opacity: 0.8 }

      /*background:  no-repeat center center;*/

      /* button */
      .button, .btn, .buttons a { background: #C00; border: 1px solid #C00; color: #FFF; border-radius: 10px; padding: 3px 7px; }
      .button:hover, .btn:hover, .buttons a:hover {  background: #FFF; color: #C00; }


      /* style: forms */
      input { font-size: 140%; padding: 8px 12px; width: 100%; }
      input { margin-bottom: 20px; }

      #keyWIF { font-weight: bold; font-size: 30px; font-size: 48px; margin-bottom: 20px; text-align: center}
    </style>

  </body>
</html>
